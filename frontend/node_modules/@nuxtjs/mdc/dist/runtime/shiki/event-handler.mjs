import { loadWasm } from "shikiji";
import { eventHandler, getQuery, lazyEventHandler } from "h3";
import { useShikiHighlighter } from "./highlighter.mjs";
import { useRuntimeConfig } from "#imports";
export default lazyEventHandler(async () => {
  const { highlight } = useRuntimeConfig().mdc;
  await loadWasm(
    (imports) => import("shikiji/onig.wasm").then((mod) => mod.default(imports)).then((exports) => ({ exports }))
  );
  const shiki = useShikiHighlighter(highlight);
  return eventHandler(async (event) => {
    const { code, lang, theme: themeString, highlights: highlightsString } = getQuery(event);
    const theme = JSON.parse(themeString);
    const highlights = highlightsString ? JSON.parse(highlightsString) : void 0;
    return await shiki.getHighlightedAST(code, lang, theme, { highlights });
  });
});
